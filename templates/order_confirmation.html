{% extends 'base.html' %}
{% block title %}Order Confirmation | Bigoh{% endblock %}
{% block extra_head %}
<style>
    .confirm-hero {
      background: linear-gradient(135deg, #0f172a 0%, #0b1220 60%, #0a0f1a 100%);
      color: #fff;
      border-radius: 18px;
      padding: 28px;
      margin-top: 16px;
    }
    .ref-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.15);
      font-weight: 600;
      letter-spacing: 1px;
    }
    .payment-badges { display:flex; flex-wrap:wrap; gap:8px; }
    .payment-badges span {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(15, 23, 42, 0.08);
      font-size:12px;
      font-weight:600;
      color:#e2e8f0;
    }
    .invoice-page {
      color: #111827;
    }
    .invoice-wrap {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 32px;
    }
    .invoice-top {
      display: flex;
      justify-content: space-between;
      gap: 24px;
      flex-wrap: wrap;
    }
    .invoice-company,
    .invoice-customer {
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-line;
    }
    .invoice-title {
      margin-top: 24px;
      font-size: 22px;
      color: #6f2dbd;
      font-weight: 700;
    }
    .invoice-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      margin-top: 12px;
      font-size: 13px;
    }
    .invoice-meta .meta-label {
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 11px;
      color: #6b7280;
    }
    .invoice-meta .meta-value {
      margin-top: 4px;
      font-weight: 600;
      color: #111827;
    }
    .invoice-divider {
      border-top: 2px solid #6f2dbd;
      margin: 16px 0 8px;
    }
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .invoice-table th {
      text-align: left;
      padding: 10px 8px;
      color: #374151;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 700;
    }
    .invoice-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
    }
    .invoice-table .text-end { text-align: right; }
    .invoice-total {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
    }
    .invoice-total-box {
      min-width: 220px;
      font-size: 14px;
    }
    .invoice-total-row {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
    }
    .invoice-total-row strong {
      color: #6f2dbd;
    }
    .invoice-footer {
      margin-top: 18px;
      font-size: 12px;
      color: #6b7280;
    }
    .scu-wrap {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-top: 16px;
      align-items: flex-start;
    }
    .scu-info {
      font-size: 12px;
      color: #111827;
    }
    .scu-info .scu-title {
      font-weight: 700;
      margin-bottom: 6px;
    }
    .scu-info .scu-row {
      margin-top: 4px;
    }
    .scu-qr img {
      width: 120px;
      height: 120px;
      border: 1px solid #e5e7eb;
      padding: 6px;
    }
    .print-navbar {
      border-bottom: 1px solid #e5e7eb;
      background: #ffffff;
    }
    @media print {
      .no-print { display: none !important; }
      body { background: #ffffff !important; }
      .invoice-wrap { border: none; padding: 0; }
      .print-navbar { border: none; }
    }
  </style>
{% endblock %}
{% block navbar %}
  {% if request.args.get("print") == "1" %}
    <nav class="print-navbar">
      <div class="container py-2 d-flex align-items-center gap-2">
        <img src="{{ url_for('static', filename='images/logo.jpeg') }}" alt="{{ business_name }} logo" style="height:32px;width:auto;">
        <strong>{{ business_name }}</strong>
      </div>
    </nav>
  {% else %}
    {{ super() }}
  {% endif %}
{% endblock %}
{% block footer %}
  {% if request.args.get("print") != "1" %}
    {{ super() }}
  {% endif %}
{% endblock %}
{% block content %}
{% set is_print = request.args.get("print") == "1" %}
<div class="container py-3">
  {% if is_print %}
  <div class="invoice-page">
    <div class="invoice-wrap">
      <div class="invoice-top">
        <div class="invoice-company">
          <strong>{{ business_name }}</strong><br>
          {{ business_address }}
          {% if business_reg_no %}
          <br>Reg: {{ business_reg_body }} {{ business_reg_no }}
          {% endif %}
        </div>
        <div class="invoice-customer text-end">
          <strong>{{ customer_name }}</strong><br>
          {{ order[2] }}
        </div>
      </div>

      <div class="invoice-title">Invoice {{ reference }}</div>
      <div class="invoice-meta">
        <div>
          <div class="meta-label">Invoice Date</div>
          <div class="meta-value">{{ issued_at.strftime("%d/%m/%Y") }}</div>
        </div>
        <div>
          <div class="meta-label">Due Date</div>
          <div class="meta-value">{{ issued_at.strftime("%d/%m/%Y") }}</div>
        </div>
        <div>
          <div class="meta-label">Reference</div>
          <div class="meta-value">{{ reference }}</div>
        </div>
      </div>

      <div class="invoice-divider"></div>
      <table class="invoice-table">
        <thead>
          <tr>
            <th>Description</th>
            <th class="text-end">Quantity</th>
            <th class="text-end">Unit Price</th>
            <th class="text-end">Taxes</th>
            <th class="text-end">Taxable Amount</th>
            <th class="text-end">Total Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          {% set unit_price = it[2] or 0 %}
          {% set qty = it[3] or 0 %}
          {% set line_total = it[4] or 0 %}
          <tr>
            <td>{{ it[1] }}</td>
            <td class="text-end">{{ "{:,.2f}".format(qty) }}</td>
            <td class="text-end">KES {{ "{:,.2f}".format(unit_price) }}</td>
            <td class="text-end">0%</td>
            <td class="text-end">KES {{ "{:,.2f}".format(line_total) }}</td>
            <td class="text-end">KES {{ "{:,.2f}".format(line_total) }}</td>
          </tr>
          {% endfor %}
          {% if items|length == 0 %}
          <tr>
            <td colspan="6" class="text-center text-muted">No items found.</td>
          </tr>
          {% endif %}
        </tbody>
      </table>

      <div class="invoice-divider"></div>
      <div class="invoice-total">
        <div class="invoice-total-box">
          {% if discount and discount > 0 %}
          <div class="invoice-total-row">
            <div>Discount</div>
            <strong>-KES {{ "{:,.2f}".format(discount or 0) }}</strong>
          </div>
          {% endif %}
          <div class="invoice-total-row">
            <div>Total</div>
            <strong>KES {{ "{:,.2f}".format(order[5] or 0) }}</strong>
          </div>
        </div>
      </div>

      <div class="scu-wrap">
        <div class="scu-info">
          <div class="scu-title">SCU Information</div>
          <div class="scu-row">Date: {{ scu_info.date }}</div>
          <div class="scu-row">SCU ID: {{ scu_info.scu_id }}</div>
          <div class="scu-row">Receipt Number: {{ scu_info.receipt_number }}</div>
          <div class="scu-row">Item Count: {{ scu_info.item_count }}</div>
          <div class="scu-row">Internal Data: {{ scu_info.internal_data }}</div>
          <div class="scu-row">Receipt Signature: {{ scu_info.receipt_signature }}</div>
        </div>
        {% if qr_data_uri %}
        <div class="scu-qr">
          <img src="{{ qr_data_uri }}" alt="Invoice QR Code">
        </div>
        {% endif %}
      </div>

      <div class="invoice-footer">
        Payment Communication: INV/{{ reference }}<br>
        Support: {{ support_phone }}{% if support_whatsapp %} (WhatsApp {{ support_whatsapp }}){% endif %}{% if support_email %} | {{ support_email }}{% endif %}
      </div>
    </div>
  </div>
  {% else %}
    

    <section class="confirm-hero">
      <h3 class="mb-2">Order Confirmed</h3>
      <div class="ref-badge">Reference: {{ reference }}</div>
      <p class="mt-3 mb-0">Thank you for your order. Please review the details below.</p>
    </section>
    <div class="trust-strip mt-3">
      <span><i class="fa-solid fa-lock"></i> Secure checkout (SSL)</span>
      <span><i class="fa-solid fa-circle-check"></i> Quality checked</span>
      <span><i class="fa-solid fa-shield-halved"></i> Dispute support</span>
    </div>
    <div class="payment-badges mt-2">
      {% for pm in payment_methods %}
      <span>
        {% if pm.icon %}<i class="{{ pm.icon }}"></i>{% endif %}
        {{ pm.label }}
      </span>
      {% endfor %}
      <span><i class="fa-solid fa-shield-check"></i> SSL Secure</span>
      <span><i class="fa-solid fa-truck"></i> Pay on Delivery</span>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <h6>Status</h6>
          <div class="text-muted">{{ order[4] }}</div>
          <h6 class="mt-3">Payment</h6>
          <div class="text-muted">{{ order[3] }}</div>
          <h6 class="mt-3">Delivery Location</h6>
          <div class="text-muted">{{ order[2] }}</div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="border rounded p-3">
          <h6>Items</h6>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Unit Price</th>
                  <th>Qty</th>
                  <th>Line Total</th>
                </tr>
              </thead>
              <tbody>
                {% for it in items %}
                <tr>
                  <td>
                    {{ it[1] }}
                    <div class="small mt-1">
                      <a href="/single_item/{{ it[0] }}#reviews">Leave a review</a>
                    </div>
                  </td>
                  <td>KES {{ "{:,.2f}".format(it[2] or 0) }}</td>
                  <td>{{ it[3] }}</td>
                  <td class="text-danger">KES {{ "{:,.2f}".format(it[4] or 0) }}</td>
                </tr>
                {% endfor %}
                {% if items|length == 0 %}
                <tr>
                  <td colspan="4" class="text-center text-muted">No items found.</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          {% if discount and discount > 0 %}
          <div class="d-flex justify-content-between align-items-center mt-3">
            <strong>Discount</strong>
            <strong class="text-success">-KES {{ "{:,.2f}".format(discount or 0) }}</strong>
          </div>
          {% if discount_reason %}
          <div class="text-muted small mt-1">{{ discount_reason }}</div>
          {% endif %}
          {% endif %}
          <div class="d-flex justify-content-between align-items-center mt-2">
            <strong>Total</strong>
            <strong class="text-danger">KES {{ "{:,.2f}".format(order[5] or 0) }}</strong>
          </div>

          {% if wa_url %}
          <div class="mt-3">
            <a class="btn btn-success" href="{{ wa_url }}" target="_blank">Continue to WhatsApp</a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="mt-4">
      <a class="btn btn-dark" href="{{ url_for('order_confirmation', order_id=order[0]) }}?print=1">Download / Print order details</a>
      <div class="text-muted small mt-2">Final receipt will be sent by admin after confirmation.</div>
      {% if session.get("is_admin") %}
      <div class="mt-2">
        <a class="btn btn-outline-dark" href="{{ url_for('order_receipt', order_id=order[0]) }}">View final receipt (admin)</a>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
{% endblock %}
{% block extra_scripts %}
<script>
  (function () {
    var params = new URLSearchParams(window.location.search);
    if (params.get("print") === "1") {
      window.print();
    }
  })();
</script>
{% endblock %}
