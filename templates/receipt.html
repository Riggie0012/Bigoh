{% extends 'base.html' %}
{% block title %}Receipt | {{ business_name }}{% endblock %}
{% block extra_head %}
<style>
  .receipt-wrap {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 24px 28px 28px;
    position: relative;
    overflow: hidden;
  }
  .paid-ribbon {
    position: absolute;
    top: 18px;
    right: -36px;
    transform: rotate(45deg);
    background: #8dd34a;
    color: #ffffff;
    font-weight: 700;
    padding: 6px 48px;
    font-size: 12px;
    letter-spacing: 1px;
  }
  .receipt-header {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: space-between;
    align-items: flex-start;
  }
  .receipt-logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .receipt-logo img {
    height: 40px;
    width: auto;
  }
  .payment-details {
    text-align: right;
    font-size: 12px;
    color: #374151;
    white-space: pre-line;
  }
  .invoice-bar {
    margin-top: 14px;
    background: #f3f4f6;
    padding: 10px 12px;
    font-size: 13px;
    font-weight: 600;
  }
  .invoice-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 8px;
    margin-top: 6px;
    font-size: 12px;
    color: #4b5563;
  }
  .invoice-section {
    margin-top: 14px;
    font-size: 12px;
  }
  .invoice-section strong {
    display: block;
    margin-bottom: 4px;
  }
  .invoice-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 12px;
  }
  .invoice-table th,
  .invoice-table td {
    border: 1px solid #e5e7eb;
    padding: 6px 8px;
  }
  .invoice-table th {
    background: #f9fafb;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.04em;
  }
  .text-end { text-align: right; }
  .summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
    font-size: 12px;
  }
  .summary-table td {
    border: 1px solid #e5e7eb;
    padding: 6px 8px;
  }
  .summary-table td:first-child {
    text-align: right;
    font-weight: 600;
  }
  .summary-table td:last-child {
    text-align: right;
    width: 150px;
  }
  .transactions {
    margin-top: 18px;
    font-size: 12px;
  }
  .transactions table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 6px;
  }
  .transactions th,
  .transactions td {
    border: 1px solid #e5e7eb;
    padding: 6px 8px;
  }
  .transactions th {
    background: #f9fafb;
    font-weight: 700;
  }
  .receipt-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  @media print {
    .no-print { display: none !important; }
    body { background: #ffffff !important; }
    .receipt-wrap { border: none; padding: 0; }
  }
</style>
{% endblock %}
{% block content %}
<div class="container py-3">
  <div class="receipt-wrap">
    <div class="paid-ribbon">PAID</div>
    <div class="receipt-header">
      <div class="receipt-logo">
        <img src="{{ business_logo }}" alt="{{ business_name }} logo">
        <div>
          <div><strong>{{ business_name }}</strong></div>
          <div class="text-muted">{{ business_address }}</div>
        </div>
      </div>
      <div class="payment-details">
        <strong>{{ payment_details_title }}</strong>
        {% if payment_details_lines|length %}
        <div>
          {% for line in payment_details_lines %}
          {{ line }}<br>
          {% endfor %}
        </div>
        {% else %}
        <div>Payment method: {{ order[3] }}</div>
        {% endif %}
      </div>
    </div>

    <div class="invoice-bar">Invoice #{{ reference }}</div>
    <div class="invoice-meta">
      <div>Invoice Date: {{ receipt_date.strftime("%A, %B %d, %Y") }}</div>
      <div>Due Date: {{ receipt_date.strftime("%A, %B %d, %Y") }}</div>
    </div>

    <div class="invoice-section">
      <strong>Invoiced To</strong>
      {{ customer[0] }}<br>
      {% if customer[2] %}{{ customer[2] }}<br>{% endif %}
      {{ order[2] }}<br>
      {% if customer[1] %}{{ customer[1] }}{% endif %}
    </div>

    <table class="invoice-table">
      <thead>
        <tr>
          <th>Description</th>
          <th class="text-end">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>{{ it[1] }}</td>
          <td class="text-end">Ksh {{ "{:,.2f}".format(it[4] or 0) }}</td>
        </tr>
        {% endfor %}
        {% if items|length == 0 %}
        <tr>
          <td colspan="2" class="text-center text-muted">No items found.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <table class="summary-table">
      <tr>
        <td>Sub Total</td>
        <td>Ksh {{ "{:,.2f}".format(items_total or 0) }}</td>
      </tr>
      <tr>
        <td>0.00% VAT</td>
        <td>Ksh 0.00</td>
      </tr>
      <tr>
        <td>Credit</td>
        <td>{% if discount and discount > 0 %}-Ksh {{ "{:,.2f}".format(discount or 0) }}{% else %}Ksh 0.00{% endif %}</td>
      </tr>
      <tr>
        <td>Total</td>
        <td><strong>Ksh {{ "{:,.2f}".format(order_total or 0) }}</strong></td>
      </tr>
    </table>

    <div class="transactions">
      <strong>Transactions</strong>
      <table>
        <thead>
          <tr>
            <th>Transaction Date</th>
            <th>Gateway</th>
            <th>Transaction ID</th>
            <th class="text-end">Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for tx in transactions %}
          <tr>
            <td>{{ tx.date }}</td>
            <td>{{ tx.gateway }}</td>
            <td>{{ tx.transaction_id }}</td>
            <td class="text-end">Ksh {{ "{:,.2f}".format(tx.amount or 0) }}</td>
          </tr>
          {% endfor %}
          {% if transactions|length == 0 %}
          <tr>
            <td colspan="4" class="text-center text-muted">No transactions recorded.</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="receipt-actions mt-3 no-print">
    <a class="btn btn-outline-dark" href="{{ url_for('order_confirmation', order_id=order[0]) }}">Back to order</a>
  </div>
</div>
{% endblock %}
