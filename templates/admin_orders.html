{% extends 'base.html' %}
{% block title %}Orders | Bigoh Admin{% endblock %}
{% block extra_head %}
<style>
    :root {
      --bg: #0e0f12;
      --panel: #15171c;
      --panel-2: #1c1f26;
      --border: #232733;
      --text: #f4f4f5;
      --muted: #98a2b3;
      --orange: #ff8a00;
      --green: #3ddc97;
      --blue: #4f8cff;
      --yellow: #f4b740;
      --red: #f87171;
    }

    body {
      font-family: "Space Grotesk", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #1b1f2a 0%, #0e0f12 45%, #0b0c10 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .shell {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    .sidebar {
      background: #0c0d11;
      border-right: 1px solid var(--border);
      padding: 28px 20px;
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .brand {
      font-weight: 700;
      font-size: 20px;
      letter-spacing: 0.4px;
      margin-bottom: 24px;
    }

    .brand span {
      color: var(--orange);
    }

    .nav-section {
      margin-top: 28px;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .nav-links a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      color: var(--text);
      text-decoration: none;
      border-radius: 10px;
      margin-top: 8px;
      background: transparent;
    }

    .nav-links a.active,
    .nav-links a:hover {
      background: var(--panel-2);
    }

    .content {
      padding: 28px 28px 40px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
    }

    .pill {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      color: var(--muted);
    }

    .table-dark {
      --bs-table-bg: transparent;
      --bs-table-striped-bg: #12141a;
      --bs-table-striped-color: var(--text);
      border-color: var(--border);
    }

    .table-dark th,
    .table-dark td {
      border-color: var(--border);
    }
    .panel .table-responsive {
      overflow-x: auto;
    }
    .orders-table {
      width: 100%;
      table-layout: auto;
    }
    .orders-table th,
    .orders-table td {
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere;
      vertical-align: middle;
      line-height: 1.25;
      padding: 0.5rem 0.45rem;
      font-size: 0.9rem;
    }
    .orders-table th {
      font-size: 0.72rem;
      letter-spacing: 0.05em;
      color: var(--muted);
      text-transform: uppercase;
    }
    .orders-table .mono {
      white-space: normal;
      word-break: break-all;
      font-size: 0.88rem;
    }
    .orders-table .update-form {
      min-width: 0;
    }
    .orders-table .update-select {
      min-width: 0;
      font-size: 0.78rem;
      padding: 4px 26px 4px 8px;
    }
    .orders-table .btn-save {
      white-space: nowrap;
      padding: 0.24rem 0.5rem;
      font-size: 0.74rem;
    }
    .orders-table .view-btn {
      white-space: nowrap;
      padding: 0.24rem 0.5rem;
      font-size: 0.78rem;
    }
    @media (max-width: 1500px) {
      .orders-table .col-phone,
      .orders-table .cell-phone {
        display: none;
      }
    }
    @media (max-width: 1280px) {
      .orders-table .col-payment,
      .orders-table .cell-payment {
        display: none;
      }
    }
    @media (max-width: 1120px) {
      .orders-table .col-reference,
      .orders-table .cell-reference {
        display: none;
      }
      .orders-table .update-form {
        display: grid !important;
        gap: 4px !important;
      }
      .orders-table .btn-save {
        width: 100%;
      }
    }
    @media (max-width: 980px) {
      .orders-table thead {
        display: none;
      }
      .orders-table tbody {
        display: block;
      }
      .orders-table tr {
        display: block;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #12141a;
        margin-bottom: 10px;
        overflow: hidden;
      }
      .orders-table td {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        font-size: 0.84rem;
        padding: 0.52rem 0.72rem;
        border: 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.18);
        white-space: normal;
        word-break: normal;
        overflow-wrap: break-word;
        text-align: right;
      }
      .orders-table td:last-child {
        border-bottom: 0;
      }
      .orders-table td::before {
        content: attr(data-label);
        flex: 0 0 42%;
        max-width: 42%;
        color: var(--muted);
        font-size: 0.67rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        text-align: left;
      }
      .orders-table .cell-reference,
      .orders-table .cell-phone,
      .orders-table .cell-location,
      .orders-table .cell-payment {
        display: flex;
      }
      .orders-table .mono {
        word-break: normal;
        white-space: normal;
      }
      .orders-table .badge-status {
        font-size: 10px;
        padding: 4px 7px;
      }
      .orders-table .update-form {
        width: 100%;
        display: grid !important;
        gap: 6px !important;
      }
      .orders-table .update-select,
      .orders-table .btn-save,
      .orders-table .view-btn {
        width: 100%;
      }
      .orders-table .view-btn {
        text-align: center;
      }
      .orders-table td.cell-empty {
        display: block;
        text-align: center;
        padding: 12px;
      }
      .orders-table td.cell-empty::before {
        content: none;
      }
    }

    .badge-status {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
    }

    .status-PENDING { background: rgba(244, 183, 64, 0.2); color: var(--yellow); }
    .status-PROCESSING { background: rgba(79, 140, 255, 0.2); color: var(--blue); }
    .status-DELIVERED { background: rgba(34, 197, 94, 0.18); color: #22c55e; }
    .status-COMPLETED { background: rgba(61, 220, 151, 0.2); color: var(--green); }
    .status-CANCELLED { background: rgba(248, 113, 113, 0.2); color: var(--red); }

    .admin-select {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .admin-select:focus {
      border-color: rgba(255, 138, 0, 0.6);
      box-shadow: none;
    }

    .mono {
      font-family: "JetBrains Mono", monospace;
    }

    @media (max-width: 980px) {
      .shell {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: static;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
    }
  </style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
{% endblock %}
{% block navbar %}{% endblock %}
{% block footer %}{% endblock %}
{% block content %}
<div class="shell">
    <aside class="sidebar">
      <div class="brand">Bigoh Admin</div>
      <div class="nav-links">
        <a href="/admin">Dashboard</a>
        <a href="/admin/flash-sale">Flash Sale</a>
        <a href="/admin/sponsored-products">Sponsored Products</a>
        <a href="/admin/products">Products</a>
        <a class="active" href="/admin/orders">Orders</a>
        <a href="/admin/review-photos">Review Photos</a>
        <a href="/upload">Upload Products</a>
        <a href="/">Storefront</a>
        <a href="/logout">Logout</a>
      </div>

      <div class="nav-section">Quick Actions</div>
      <div class="nav-links">
        <a href="/cart">View Cart</a>
        <a href="/search">Search Products</a>
      </div>
    </aside>

    <main class="content">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h3 class="mb-1">Orders</h3>
          <div class="text-muted">Track payments, locations, and fulfillment.</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <form method="POST" action="{{ url_for('admin_delete_completed_orders') }}" onsubmit="return confirm('Delete all COMPLETED orders and their items? This cannot be undone.');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-sm btn-outline-danger" type="submit">Delete Completed</button>
          </form>
          <div class="pill">{{ orders|length if orders else 0 }} orders</div>
        </div>
      </div>

      {% if cleanup_status == "ok" %}
      <div class="alert alert-success py-2 px-3 mb-3">
        Deleted {{ cleanup_deleted_orders }} completed order(s), {{ cleanup_deleted_items }} item row(s), and {{ cleanup_deleted_reviews }} review reminder row(s).
      </div>
      {% elif cleanup_status == "error" %}
      <div class="alert alert-danger py-2 px-3 mb-3">
        Could not delete completed orders. Check logs and try again.
      </div>
      {% endif %}
      {% if site_message %}
      <div class="alert alert-{{ site_message_level }} py-2 px-3 mb-3">
        {{ site_message }}
      </div>
      {% endif %}

      <section class="panel">
        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle orders-table">
            <thead>
              <tr>
                <th class="col-id">#</th>
                {% if has_reference %}<th class="col-reference">Reference</th>{% endif %}
                <th class="col-customer">Customer</th>
                <th class="col-phone">Phone</th>
                <th class="col-location">Location</th>
                <th class="col-payment">Payment</th>
                <th class="col-status">Status</th>
                <th class="col-subtotal">Subtotal</th>
                <th class="col-details">Details</th>
                <th class="col-update">Update</th>
              </tr>
            </thead>
            <tbody>
              {% for o in orders %}
              <tr>
                <td class="mono cell-id" data-label="Order ID">{{ o[0] }}</td>
                {% if has_reference %}
                  <td class="mono cell-reference" data-label="Reference">{{ o[1] or "-" }}</td>
                  <td class="cell-customer" data-label="Customer">{{ o[2] or "Customer" }}</td>
                  <td class="mono cell-phone" data-label="Phone">{{ o[3] or "-" }}</td>
                  <td class="cell-location" data-label="Location">{{ o[4] }}</td>
                  <td class="cell-payment" data-label="Payment">{{ (o[5] or "-")|replace("_", " ") }}</td>
                  <td class="cell-status" data-label="Status">
                    <span class="badge-status status-{{ o[6] }}">{{ o[6] }}</span>
                  </td>
                  <td class="text-danger mono cell-subtotal" data-label="Subtotal">KES {{ "{:,.2f}".format(o[7] or 0) }}</td>
                  <td class="cell-details" data-label="Details">
                    <a href="/admin/orders/{{ o[0] }}" class="btn btn-sm btn-outline-light view-btn">View</a>
                  </td>
                  <td class="cell-update" data-label="Update">
                    <form method="POST" action="{{ url_for('admin_update_order_status', order_id=o[0]) }}" class="d-flex gap-2 update-form js-status-form">
           <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <select name="status" class="form-select form-select-sm admin-select update-select js-status-select">
                        {% for s in ["PENDING", "PROCESSING", "DELIVERED", "COMPLETED", "CANCELLED"] %}
                          <option value="{{ s }}" {% if o[6] == s %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                      </select>
                      <button class="btn btn-sm btn-primary btn-save" type="submit">Save</button>
                    </form>
                  </td>
                {% else %}
                  <td class="cell-customer" data-label="Customer">{{ o[1] or "Customer" }}</td>
                  <td class="mono cell-phone" data-label="Phone">{{ o[2] or "-" }}</td>
                  <td class="cell-location" data-label="Location">{{ o[3] }}</td>
                  <td class="cell-payment" data-label="Payment">{{ (o[4] or "-")|replace("_", " ") }}</td>
                  <td class="cell-status" data-label="Status">
                    <span class="badge-status status-{{ o[5] }}">{{ o[5] }}</span>
                  </td>
                  <td class="text-danger mono cell-subtotal" data-label="Subtotal">KES {{ "{:,.2f}".format(o[6] or 0) }}</td>
                  <td class="cell-details" data-label="Details">
                    <a href="/admin/orders/{{ o[0] }}" class="btn btn-sm btn-outline-light view-btn">View</a>
                  </td>
                  <td class="cell-update" data-label="Update">
                    <form method="POST" action="{{ url_for('admin_update_order_status', order_id=o[0]) }}" class="d-flex gap-2 update-form js-status-form">
           <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <select name="status" class="form-select form-select-sm admin-select update-select js-status-select">
                        {% for s in ["PENDING", "PROCESSING", "DELIVERED", "COMPLETED", "CANCELLED"] %}
                          <option value="{{ s }}" {% if o[5] == s %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                      </select>
                      <button class="btn btn-sm btn-primary btn-save" type="submit">Save</button>
                    </form>
                  </td>
                {% endif %}
              </tr>
              {% endfor %}
              {% if orders|length == 0 %}
              <tr>
                <td colspan="{{ 10 if has_reference else 9 }}" class="text-center text-muted cell-empty">No orders found.</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>
  <script>
    const showStatusToast = (message, level = "warning") => {
      if (!message) return;
      if (typeof window.showCartToast === "function") {
        const toastLevel = level === "error" ? "danger" : level;
        window.showCartToast(message, toastLevel);
        return;
      }
      window.alert(message);
    };

    const applyBadgeStatus = (form, status) => {
      const row = form.closest("tr");
      if (!row) return;
      const badge = row.querySelector(".badge-status");
      if (!badge) return;
      badge.textContent = status;
      badge.className = `badge-status status-${status}`;
    };

    const submitStatusForm = async (form, select) => {
      if (!form || !select) return;
      const previousStatus = select.dataset.prevValue || select.value;
      const nextStatus = select.value;
      if (!nextStatus || nextStatus === previousStatus) {
        select.dataset.prevValue = nextStatus;
        return;
      }

      const submitButton = form.querySelector("button[type='submit']");
      const originalBtnLabel = submitButton ? submitButton.textContent : "";
      const payload = new FormData(form);
      payload.set("status", nextStatus);
      select.disabled = true;
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = "Saving...";
      }

      try {
        const res = await fetch(form.action, {
          method: "POST",
          body: payload,
          credentials: "same-origin",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "Accept": "application/json"
          }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(data.message || "Unable to update order status.");
        }
        const appliedStatus = String(data.new_status || nextStatus).toUpperCase();
        select.value = appliedStatus;
        select.dataset.prevValue = appliedStatus;
        applyBadgeStatus(form, appliedStatus);
        showStatusToast(data.message || "Order status updated.", "success");
      } catch (err) {
        select.value = previousStatus;
        showStatusToast(err.message || "Unable to update order status.", "warning");
      } finally {
        select.disabled = false;
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalBtnLabel;
        }
      }
    };

    document.querySelectorAll(".js-status-select").forEach((select) => {
      select.dataset.prevValue = select.value;
    });

    document.querySelectorAll(".js-status-form").forEach((form) => {
      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const select = form.querySelector(".js-status-select");
        submitStatusForm(form, select);
      });
    });
  </script>
{% endblock %}
